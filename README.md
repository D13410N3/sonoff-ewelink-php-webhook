# Система управления устройствами Sonoff через web и их мониторинг

## Функционал:
	Просмотр, изменение, удаление: комнат, устройств
	Просмотр полной статистики использования (включений, выключений, общее время работы, среднее время работы) за все время, на указанную дату
	Просмотр событий
	Включение / выключение устройств через сайт
	Frontend - Bootstrap 4.4.1. Удобное использование и с компьютера, и с мобильных устройств.

## Для работы требуется:
	1) PHP 5 (PHP 7 подойдет только при условии самостоятельной компиляции legacy-библиотеки mysql.so либо если вы самостоятельно перепишите исходники на mysqli/pdo/etc.)
	2) MariaDB / MySQL. Обратите внимание - для разработки использовался движок Aria, если вы используете обычный MySQL и у вас нет Aria - перепишите sql-дамп на MyISAM / InnoDB / etc.
	3) Telegram-бот и доступ к его API-ключу
	4) Чат в Telegram для уведомлений о включении
	5) Учетная запись на IFTTT.com


## Порядок работы

0. Подготовка скрипта
	1. Склонируйте репозиторий в удобное место - главное, чтобы оно было доступно через http (а лучше - https)
	2. Переименуйте файл settings.sample.php в settings.php
	3. Создайте базу данных, откройте settings.php и впишите туда настройки базы данных (массив $_DATABASE)
	4. Импортируйте SQL-файл структуры в БД
	5. Отредактируйте переменную $_PASSWORD и впишите туда свой пароль для доступа к сайту (он же будет ключом для входящих ifttt-запросов)
	6. Выдайте web-серверу права на запись в файл actions.log. Эио можно сделать через chmod (не рекомендуется), либо просто сменив владельца файла через chown

1. Подготовка Telegram-бота
	1. Создайте нового бота через @botfather, получите его API-ключ
	2. Создайте новую группу (или используйте существующую). Можно использовать личные сообщения с ботом
	3. Узнайте ID группы. Как вариант, можно добавить моего бота @ADARefactorBot в чат и написать команду /whoami (бота потом из чата лучше удалить, вы же не хотите, чтобы я за вами следил?). Если вы хотите использовать личные сообщения со своим ботом, ту же самую команду напишите в личные сообщения
	4. Откройте файл settings.php и впишите в настройки API-ключ бота и ID чата (массив $_TG)

2. Заполните сайт
	1. Создайте требуемые комнаты
	2. Добавьте оборудование. Каждый канал == одно устройство, т.е., например, выключатели T2 или Sonoff Dual будут работать как 2 устройства, а выключатель T3 - как 3 устройства. Обратите внимание на пункт "Короткое название". Оно должно быть уникальным и не содержать в себе ничего, кроме букв латинского алфавита и цифр. В дальнейшем оно будет использоваться для обращения к серверам IFTTT и для получения вебхуков от них же.

3. Первичная настройка IFTTT
	1. Создайте учетную запись на ifttt.com (разумеется, можно использовать существующую)
	2. Подключите сервис ewelink - https://ifttt.com/ewelink , пройдите процедуру авторизации
	3. Подключите сервис Maker Webhook - https://ifttt.com/maker_webhooks, в верхнем правом углу нажмите кнопку "Documentation"
	4. На открывшейся странице скопируйте ключ - Your key is: ***
	5. Впишите его в settings.php (массив $_IFTTT)

4. Создание апплетов
	1. На каждое устройство (в т.ч. на каждый канал в случае с многоканальными устройствами) необходимо создать 4 апплета на ifttt:
		1. Включение (через кнопку на самом устройстве или через приложение ewelink)
		2. Выключение (через кнопку на самом устройстве или через приложение ewelink)
		3. Включение (с сайта)
		4. Выключение (с сайта)
	
	2. Порядок настройки неважен, но я рекомендую начать с первых двух:
		1. Открыть меню создания апплетов - https://ifttt.com/create и нажать на "+" после слова IF
		2. В поиске найти eWeLink Smart Home и выбрать нужный тип устройства:
			1. Sonoff Basic, Sonoff Slampher - "1 Channel Switch turned on or off"
			2. Sonoff Dual, Sonoff Touch T2 - "1 Channel Switch turned on or off"
			3. Sonoff T3 - "3 Channel Switch turned on or off"
			4. В случае использования каких-то других устройств попробуйте найти их самостоятельно (к сожалению, я использую только перечисленные выше)
		3. Выберите нужное устройство из списка и выберите тип события (on или off). В случае с многоканальными устройствами необходимо так же выбрать channel
		4. Нажмите "+" слева от слова "THAT"
		5. Найдите в поиске Webhooks и далее в нем "Make a web request"
		6. Укажите URL-адрес вида: https://yoursite.ru/address/to/process.php?key=%KEY%&switch=%SWITCH%&action=%ACTION
		где
			1. %KEY% - пароль для доступа $_PASSWORD
			2. %SWITCH% - краткое название устройства (см пункт 2.2)
			3. %ACTION% - тип события (on или off)
		7. Выберите Method - GET, Content-type - text/plain, поле Body оставьте пустым
		8. Укажите любое имя для апплета (оно не будет нигде фигурировать, можно оставить стандартное). Если оставить тумблер Receive notifications when this Applet runs включенным, будут приходить уведомления о каждом событии (например, в приложение ifttt на телефон). Опять же, ни на что не влияет
		9. Создайте аналогичный апплет на другое событие (если начали с включения, то сделайте выключение, и наоборот)
		10. Создайте аналогичную пару апплетов на каждый канал каждого устройства 
	
		3. После создания апплета на ваш вебхук, скорее всего, придет событие с текущим состоянием устройства (т.е. как будто бы устройство было только что включено или выключено). Если на момент создания устройства оно было не в сети, событие будет проигнорировано и не записано в базу, в Telegram придет соответствующее сообщение)
	
	3. Для включения и выключения с сайта необходимо настроить "обратные" апплеты (т.е. в пункте IF - webhooks, в поле THAT - ewelink)
		1. Открыть меню создания апплетов - https://ifttt.com/create и нажать на "+" после слова IF
		2. В поиске найти Webhooks и далее выбрать Receive a web request
		3. Ввести Event Name. Оно складывается следующим образом: ewelink_%SWITCH%_%ACTION
		где
			%SWITCH% - краткое название устройства (см пункт 2.2)
			%ACTION% - тип события (on или off)
		4. Нажмите "+" слева от слова "THAT"
		5. В поиске найти eWeLink Smart Home и выбрать нужный тип устройства:
			1. Sonoff Basic, Sonoff Slampher - "1 Channel Switch turned on or off"
			2. Sonoff Dual, Sonoff Touch T2 - "1 Channel Switch turned on or off"
			3. Sonoff T3 - "3 Channel Switch turned on or off"
			4. В случае использования каких-то других устройств попробуйте найти их самостоятельно (к сожалению, я использую только перечисленные выше)
		6. Выберите нужное устройство из списка и выберите тип события (on или off). В случае с многоканальными устройствами необходимо так же выбрать channel
		7. Укажите любое имя для апплета (оно не будет нигде фигурировать, можно оставить стандартное). Если оставить тумблер Receive notifications when this Applet runs включенным, будут приходить уведомления о каждом событии (например, в приложение ifttt на телефон). Опять же, ни на что не влияет
		8. Создайте аналогичный апплет на другое событие (если начали с включения, то сделайте выключение, и наоборот)
		9. Создайте аналогичную пару апплетов на каждый канал каждого устройства 

5. В скрипте учтена вероятность "задвоения" событий. Как она может проявиться:
	1. IFTTT спонтанно присылает событие с последним состоянием, спустя несколько минут после этого события
	2. IFTTT дважды посылает запрос на вебхук с состоянием 
	3. IFTTT не посылает произошедшее событие, но шлет следующее, допустим, включение. Получается два одинаковых события подряд - система игнорирует последнее. Это может вызвать погрешности в статистике использования, но, к сожалению, я тут бессилен.


6. Для репорта багов и предложений используйте Issues
